<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>车友圈</title>
    @import "../include/header.inc";

</head>
<body ontouchstart>
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<div class="container" id="container"></div>

<!--首页-->
<link rel="import" href="../../../pages/circle/index.html">

<link rel="import" href="../../../model/templete/circle/list.html"> <!--优惠券列表模板-->
@import "../../../model/widget/include/toast.html";
@import "../../../model/widget/include/dialog.html";
<script src="/weixin/js/wap.min.js"></script>
<script type="text/javascript">
    $(function () {
        pageManager.show("index");
        var userId = cookie.getCookie('userId');


        $('#publish').click(function () {
            window.location.href = '/weixin/circle/send.html';
        });

        var oDiv = document.getElementById('publish');
        var disX, disY, moveX, moveY, L, T, starX, starY, starXEnd, starYEnd;

        // oDiv.addEventListener('touchstart', function (e) {
        //     e.preventDefault();//阻止触摸时页面的滚动，缩放
        //     disX = e.touches[0].clientX - this.offsetLeft;
        //     disY = e.touches[0].clientY - this.offsetTop;
        //     //手指按下时的坐标
        //     starX = e.touches[0].clientX;
        //     starY = e.touches[0].clientY;
        //     //console.log(disX);
        // });
        // oDiv.addEventListener('touchmove', function (e) {
        //     L = e.touches[0].clientX - disX;
        //     T = e.touches[0].clientY - disY;
        //     //移动时 当前位置与起始位置之间的差值
        //     starXEnd = e.touches[0].clientX - starX;
        //     starYEnd = e.touches[0].clientY - starY;
        //     //console.log(L);
        //     if (L < 0) {//限制拖拽的X范围，不能拖出屏幕
        //         L = 0;
        //     }
        //     else if (L > document.documentElement.clientWidth - this.offsetWidth) {
        //         L = document.documentElement.clientWidth - this.offsetWidth;
        //     }
        //
        //     if (T < 0) {//限制拖拽的Y范围，不能拖出屏幕
        //         T = 0;
        //     }
        //     else if (T > document.documentElement.clientHeight - this.offsetHeight) {
        //         T = document.documentElement.clientHeight - this.offsetHeight - 53;
        //     }
        //     moveX = L + 'px';
        //     moveY = T + 'px';
        //     this.style.left = moveX;
        //     this.style.top = moveY;
        // });

        //防止键盘把当前输入框给挡住
        // $('input[type="text"],textarea').on('click', function () {
        //     var target = this;
        //     setTimeout(function(){
        //         target.scrollIntoViewIfNeeded();
        //         console.log('scrollIntoViewIfNeeded');
        //     },400);
        // });


        var timer = null;
        $('input').on('focus', function() {
            clearInterval(timer);
            var index = 0;
            timer = setInterval(function() {
                if(index>5) {
                    $('body').scrollTop(1000000);
                    clearInterval(timer);
                }
                index++;
            }, 50)
        });


        var aa = new contact(function (data) {
            $("#index_slider").silderDot(data, 1800, "");
        });
        aa.list();

        var pge = $(".pageable").pageable({
            loadUpFn: function (me) {
                new contact(function (data) {
                    console.log(data);
                    for(var i = 0; i<data.return_new.length; i++){
                        var str = '';
                        str += '<div class="weui-cell_access weui-cell" data-id="' + data.return_new[i].id + '">';
                        str += '<div class="weui-cell__hd headImg"><img src="/weixin/images/placeholder/logo.png"/></div>';
                        str += '<div class="weui-cell__bd">';
                        str += '<span class="f14 gray02">爱上耗子的猫</span>';
                        str += '<div class="circle_txt f13">' + data.return_new[i].content + '</div>';
                        if(data.return_new[i].images != null){
                            str += '<div class="circle_img clearfix">';
                            for(var j = 0;j < data.return_new[i].images.length; j++){
                                str += '<img class="sendimg" src="' + data.return_new[i].images[j].images + '"/>';
                            }
                            str += '</div>';
                        }
                        str += '<div class="weui-cell bordernone operation">';
                        str += '<div class="weui-cell__hd time f10 gray04">' + data.return_new[i].addtime + '</div>';
                        str += '<div class="weui-cell__bd tr" data-id="' + data.return_new[i].id + '">';
                        str += '<i class="iconfont icon-pinglun f20 blue01 operation_btn"></i>';
                        str += '<div class="operationCont gray07_bg f10 weui-flex none" id="' + data.return_new[i].id + '">';
                        str += '<span class="weui-flex__item tc dianzan"><i class="iconfont icon-heart f16"></i><span class="dianzan_txt">点赞</span></span>';
                        str += '<span class="weui-flex__item tc pinglun"><i class="iconfont icon-pinglun-copy f16"></i><span>评论</span></span>';
                        str += '</div>';
                        str += '</div>';
                        str += '</div>';

                        if(data.return_new[i].headerimg != '' || data.return_new[i].comment != ''){
                            str += '<div class="operationTxt gray08_bg">';
                            str += '<span class="arrow_top"></span>';


                            if(data.return_new[i].headerimg != ''){
                                str += '<div class="zan_people">';
                                str += '<i class="iconfont icon-heart f12 blue02"></i>';
                                str += '<span class="blue02 f13">';
                                for(var l = 0; l < data.return_new[i].headerimg.length;l++){
                                    if(l=='0'){
                                        str += data.return_new[i].headerimg[l].nickname;
                                    }else{
                                        str += '，' + data.return_new[i].headerimg[l].nickname;
                                    }

                                }
                                str += '</span>';
                                str += '</div>';
                            }


                            if(data.return_new[i].comment != ''){
                                str += '<div class="comment topLine">';
                                for(var k = 0; k<data.return_new[i].comment.length; k++){
                                    if(data.return_new[i].comment[k].pname == ''){
                                        str += '<p class="f13 gray02"><span class="blue02">' + data.return_new[i].comment[k].author + '</span>：'+ data.return_new[i].comment[k].comment + '</p>';
                                    }else{
                                        str += '<p class="f13 gray02"><span class="blue02">' + data.return_new[i].comment[k].pname + '</span> 回复 <span class="blue02">' + data.return_new[i].comment[k].author + '</span>：'+ data.return_new[i].comment[k].comment + '</p>';
                                    }
                                }
                                str += '</div>';
                            }
                            str += '</div>';
                            str += '</div>';
                        }

                        str += '</div>';
                        $(".circle_list").append(str);
                    }
                    $('img').picLazyLoad();
                    pge.resetload();


                    $(document).on('click','.operation_btn',function () {
                        var id = $(this).parent().attr('data-id');
                        console.log(id);
                        $('#' + id).toggleClass('none');
                    });

                    $(document).on('click','.dianzan',function () {
                        var id = $(this).parent().attr('id');
                        console.log(id);
                        new contact(function () {
                            // console.log($('#' + id).find('.dianzan_txt').html());
                            $('#' + id).find('.dianzan_txt').toggleClass('none');
                            $('#' + id).find('.quxiao_txt').toggleClass('none');
                        }).liked({pid:id,userId:1})
                    });


                    var imgsObj = $('.sendimg');
                    var imgs = new Array();
                    for(var i = 0; i < imgsObj.size(); i++){
                        imgs.push(imgsObj.eq(i).attr('src'));
                    }

                    $(document).on('click','.sendimg',function () {
                        WeixinJSBridge.invoke('imagePreview', {
                            'current': $(this).attr('src'),
                            'urls': imgs
                        });
                    });
                }).list({page: 1})
            },
            loadDownFn: function (me) {
                new contact(function (data) {
                    console.log(data);
                    me.pageNumber = me.pageNumber +1;
                    // var circle = render.fill($("#tpl_list"), data.return_new);
                    // $(".circle_list").html(circle);
                    for(var i = 0; i<data.return_new.length; i++){
                        var str = '';
                        str += '<div class="circle_item weui-cell" data-id="' + data.return_new[i].id + '">';
                        if(data.return_new.headerimg == ''){
                            str += '<div class="weui-cell__hd headImg"><img src="/weixin/images/placeholder/logo.png"/></div>';
                        }else {
                            str += '<div class="weui-cell__hd headImg"><img src="' + data.return_new[i].headerimg + '"/></div>';
                        }
                        str += '<div class="weui-cell__bd">';
                        str += '<span class="f13 gray02">' + data.return_new[i].username + '</span>';
                        str += '<div class="circle_txt f13">' + data.return_new[i].content + '</div>';
                        if(data.return_new[i].images != null){
                            str += '<div class="circle_img clearfix">';
                            for(var j = 0;j < data.return_new[i].images.length; j++){
                                str += '<img class="sendimg" src="' + data.return_new[i].images[j] + '"/>';
                            }
                            str += '</div>';
                        }
                        str += '<div class="weui-cell bordernone operation">';
                        str += '<div class="weui-cell__hd time f10 gray04">' + data.return_new[i].addtime + '</div>';
                        str += '<div class="weui-cell__bd tr" data-id="' + data.return_new[i].id + '">';
                        str += '<i class="iconfont icon-pinglun f20 blue01 operation_btn"></i>';
                        str += '<div class="operationCont gray07_bg f10 weui-flex none" id="' + data.return_new[i].id + '">';
                        str += '<span class="weui-flex__item tc dianzan"><i class="iconfont icon-heart f16"></i>';
                        if(data.return_new[i].isspot == '0'){
                            str += '<span class="dianzan_txt">点赞</span>';
                            str += '<span class="quxiao_txt none">取消</span>';
                        }else{
                            str += '<span class="dianzan_txt none">点赞</span>';
                            str += '<span class="quxiao_txt">取消</span>';
                        }
                        str += '</span>';
                        str += '<span class="weui-flex__item tc pinglun"><i class="iconfont icon-pinglun-copy f16"></i><span>评论</span></span>';
                        str += '</div>';
                        str += '</div>';
                        str += '</div>';

                        if(data.return_new[i].spotlist != '' || data.return_new[i].comment != ''){
                            str += '<div class="operationTxt gray08_bg">';
                            str += '<span class="arrow_top"></span>';

                            if(data.return_new[i].spotlist != ''){
                                str += '<div class="zan_people">';
                                str += '<i class="iconfont icon-heart f13 blue02"></i>';
                                str += '<div class="blue02 f13">';
                                for(var l = 0; l < data.return_new[i].spotlist.length;l++){
                                    if(l==data.return_new[i].spotlist.length - 1){
                                        str += '<div><span>' + data.return_new[i].spotlist[l].nickname + '<span></div>';
                                    }else{
                                        str += '<div><span>' + data.return_new[i].spotlist[l].nickname + '<span>，</div>';
                                    }

                                }
                                str += '</div>';
                                str += '</div>';
                            }


                            if(data.return_new[i].comment != ''){
                                str += '<div class="comment topLine">';
                                for(var k = 0; k<data.return_new[i].comment.length; k++){
                                    if(data.return_new[i].comment[k].pname == ''){
                                        str += '<p class="f13 gray02" data-id="' + data.return_new[i].id + '"><span class="blue02">' + data.return_new[i].comment[k].author + '</span>：'+ data.return_new[i].comment[k].comment + '</p>';
                                    }else{
                                        str += '<p class="f13 gray02" data-id="' + data.return_new[i].id + '"><span class="blue02">' + data.return_new[i].comment[k].pname + '</span> 回复 <span class="blue02">' + data.return_new[i].comment[k].author + '</span>：'+ data.return_new[i].comment[k].comment + '</p>';
                                    }
                                }
                                str += '</div>';
                            }
                            str += '</div>';

                        }
                        str += '</div>';

                        
                        // str += '<div class="comment_area none comment' + data.return_new[i].id + '"><input type="text" placeholder="评论" class="comment_txt" /><i class="iconfont icon-biaoqing f24 gray04"></i></div>';
                        str += '<div class="weui-cell comment_area none comment' + data.return_new[i].id + '"><div class="weui-cell__bd"><input type="text" placeholder="评论" class="comment_txt" data-id="' + data.return_new[i].id + '" /></div><div class="weui-cell__ft"><i class="iconfont icon-biaoqing f24 gray04"></i></div></div>';

                        str += '</div>';
                        $(".circle_list").append(str);
                    }

                    $('img').picLazyLoad();
                    if (data.return_new.length < 10) {
                        pge.lock();
                        pge.noData();
                    }
                    pge.resetload();

                    $(document).on('click','.operation_btn',function () {
                        var id = $(this).parent().attr('data-id');
                        console.log(id);
                        $('#' + id).toggleClass('none');
                    });

                    $(document).on('click','.dianzan',function () {
                        var $this = $(this);
                        var id = $(this).parent().attr('id');
                        console.log(id);
                        new member(function (res) {
                            new contact(function (data) {
                                // console.log($('#' + id).find('.dianzan_txt').html());
                                // $('#' + id).find('.dianzan_txt').toggleClass('none');
                                // $('#' + id).find('.quxiao_txt').toggleClass('none');

                                console.log('点赞：'+data.isspot);
                                console.log(data);

                                if(data.isspot == '0'){
                                    console.log('取消点赞');
                                    $('#' + id).find('.dianzan_txt').removeClass('none');
                                    $('#' + id).find('.quxiao_txt').addClass('none');
                                    // var name = $(this).parent().parent().parent().parent().find('.zan_people > .blue02 span');
                                    $this.parent().parent().parent().parent().find('.zan_people > div.blue02 > div').each(function () {
                                        var name = $(this).find('span').html();
                                        if(res.nickname == name){
                                            if($(this).parent().children().length == '1'){
                                                $(this).parent().parent().parent().remove();
                                            }else {
                                                $(this).remove();
                                            }
                                        }
                                    })
                                }else{
                                    console.log('点赞');
                                    $('#' + id).find('.dianzan_txt').addClass('none');
                                    $('#' + id).find('.quxiao_txt').removeClass('none');
                                    if($this.parent().parent().parent().next().hasClass('operationTxt')){
                                        $this.parent().parent().parent().parent().find('.zan_people>div.blue02').prepend('<div><span class="11">' + res.nickname + '</span>，</div>')
                                    }else{
                                        $this.parent().parent().parent().parent().append('<div class="operationTxt gray08_bg"><span class="arrow_top"></span><div class="zan_people"><i class="iconfont icon-heart f12 blue02"></i><div class="blue02 f13"><div><span>' + res.nickname + '</span></div></div></div></div>')
                                    }
                                }
                            }).liked({pid:id,userId:1})
                        }).checkLogin({phonenum:'15056575017'});
                    });

                    // $(document).on('click','.pinglun',function () {
                    $('.pinglun').die().live('click',function () {
                        var $this=$(this);
                        var id = $(this).parent().attr('id');
                        // alert(".comment_txt" + id)
                        $(".comment" + id).removeClass('none');
                        $('.foot_menu').addClass('none');
                        $(".comment" + id).find('input').focus();

                        $(".comment" + id).find('input').die().live('change',function () {
                            var $sth=$(this);
                            var content= $(".comment" + id).find('input').val();
                            new member(function (res) {
                                new contact(function (data) {
                                    $(".comment" + id).addClass('none');
                                    $('.foot_menu').removeClass('none');
                                    // $this.parent().next('div').find('.task').removeClass('height').addClass('on');
                                    $this.parent().find('.comment').append('<p class="f13 gray02"><span class="blue02">' + res.nickname + '：</span>'+ content + '</p>');
                                    $(this).val('');
                                    // $sth.parent().parent().find('.previewCount').html(parseInt($sth.parent().parent().find('.previewCount').html())+1);
                                }).reply({pauthor:'',author:res.nickname,cid:id,comment:content});

                                $(".comment" + id).find('input').val('');
                            }).checkLogin({phonenum:'15056575017'});
                        })
                    });


                    //回复下方已有的评论
                    // $(document).on('click','.comment p',function () {
                    $('.comment p').click(function() {
                        var $this=$(this);
                        var rewho=$this.find('.blue02').first().html();
                        var id=$(this).attr('data-id');
                        $(".comment" + id).removeClass('none');
                        $('.foot_menu').addClass('none');
                        $(".comment" + id).find('input').focus();
                        // $(this).parent().parent().parent().next().find('.replyContainer').focus();
                        $(".comment" + id).find('input').focus();
                        $(".comment" + id).find('input').attr('placeholder','回复'+rewho);
                        $(".comment" + id).find('input').die().live('change',function () {
                            var content=$(".comment" + id).find('input').val();
                            var $sth=$(this);
                            new member(function (res) {
                                new contact(function (data) {
                                    $(".comment" + id).addClass('none');
                                    $('.foot_menu').removeClass('none');
                                    // $this.parent().removeClass('height').addClass('on');
                                    $this.after('<p class="f13 gray02"><span class="blue02">' + res.nickname + '</span> 回复 <span class="blue02">' + rewho + '：</span>'+ content + '</p>');

                                    // $sth.parent().parent().find('.previewCount').html(parseInt($sth.parent().parent().find('.previewCount').html())+1);
                                }).reply({pauthor:rewho,author:res.nickname,cid:id,comment:content});
                                $(".comment" + id).find('input').val('');
                            }).checkLogin({phonenum:'15056575017'});
                        })
                    });



                    var imgsObj = $('.sendimg');
                    var imgs = new Array();
                    for(var i = 0; i < imgsObj.size(); i++){
                        imgs.push(imgsObj.eq(i).attr('src'));
                    }

                    $(document).on('click','.sendimg',function () {
                        WeixinJSBridge.invoke('imagePreview', {
                            'current': $(this).attr('src'),
                            'urls': imgs
                        });
                    });

                    var timer = null;
                    $('input').on('focus', function() {
                        clearInterval(timer);
                        var index = 0;
                        timer = setInterval(function() {
                            if(index>5) {
                                $('body').scrollTop(1000000);
                                clearInterval(timer);
                            }
                            index++;
                        }, 50)
                    })
                }).list({page: me.pageNumber,userId:1})
            }
        });







        // new contact(function (data) {
        //     console.log(data);
        //     // $("#index_slider").silderDot(data, 1800, "");
        //     // var circle = render.fill($("#tpl_list"), data.return_new);
        //     // $(".circle_list").html(circle);
        //     for(var i = 0; i<data.return_new.length; i++){
        //         var str = '';
        //         str += '<div class="weui-cell_access weui-cell" data-id="' + data.return_new[i].id + '">';
        //         if(data.return_new[i].headerimg == ''){
        //             str += '<div class="weui-cell__hd headImg"><img src="/weixin/images/placeholder/logo.png"/></div>';
        //         }else {
        //             str += '<div class="weui-cell__hd headImg"><img src="' + data.return_new[i].headerimg + '"/></div>';
        //         }
        //         str += '<div class="weui-cell__bd">';
        //         str += '<span class="f12 gray02">爱上耗子的猫</span>';
        //         str += '<div class="circle_txt f11">' + data.return_new[i].content + '</div>';
        //         if(data.return_new[i].images != null){
        //             str += '<div class="circle_img clearfix">';
        //             for(var j = 0;j < data.return_new[i].images.length; j++){
        //                 str += '<img class="sendimg" src="' + data.return_new[i].images[j].images + '"/>';
        //             }
        //             str += '</div>';
        //         }
        //         str += '<div class="weui-cell bordernone operation">';
        //         str += '<div class="weui-cell__hd time f10 gray04">' + data.return_new[i].addtime + '</div>';
        //         str += '<div class="weui-cell__bd tr" data-id="' + data.return_new[i].id + '">';
        //         str += '<i class="iconfont icon-pinglun f20 blue01 operation_btn"></i>';
        //         str += '<div class="operationCont gray07_bg f10 weui-flex none" id="' + data.return_new[i].id + '">';
        //         str += '<span class="weui-flex__item tc dianzan"><i class="iconfont icon-heart f16"></i><span class="dianzan_txt">点赞</span></span>';
        //         str += '<span class="weui-flex__item tc pinglun"><i class="iconfont icon-pinglun-copy f16"></i><span>评论</span></span>';
        //         str += '</div>';
        //         str += '</div>';
        //         str += '</div>';
        //         str += '<div class="operationTxt gray08_bg">';
        //         str += '<span class="arrow_top"></span>';
        //         str += '<div class="zan_people">';
        //         str += '<i class="iconfont icon-heart f12 blue02"></i>';
        //         str += '<span class="blue02 f12">文文，小李</span>';
        //         str += '</div>';
        //         if(data.return_new[i].comment != ''){
        //             str += '<div class="comment topLine">';
        //             for(var k = 0; k<data.return_new[i].comment.length; k++){
        //                 str += '<p class="f11 gray02"><span class="blue02">' + data.return_new[i].comment[k].author + '：</span>'+ data.return_new[i].comment[k].comment + '</p>';
        //             }
        //             str += '</div>';
        //         }
        //         str += '</div>';
        //         str += '</div>';
        //         str += '</div>';
        //         $(".circle_list").append(str);
        //     }
        //
        //
        //
        //     $(document).on('click','.operation_btn',function () {
        //         var id = $(this).parent().attr('data-id');
        //         console.log(id);
        //         $('#' + id).toggleClass('none');
        //     });
        //
        //     $(document).on('click','.dianzan',function () {
        //         var id = $(this).parent().attr('id');
        //         console.log(id);
        //         new contact(function () {
        //             $('.dianzan_txt').html('取消');
        //         }).liked({pid:id,userId:1})
        //     });
        //
        //
        //
        //
        //
        //     var imgsObj = $('.sendimg');
        //     var imgs = new Array();
        //     for(var i = 0; i < imgsObj.size(); i++){
        //         imgs.push(imgsObj.eq(i).attr('src'));
        //     };
        //
        //     $(document).on('click','.sendimg',function () {
        //         WeixinJSBridge.invoke('imagePreview', {
        //             'current': $(this).attr('src'),
        //             'urls': imgs
        //         });
        //     });
        //
        // }).list()


    });
</script>

</body>
</html>