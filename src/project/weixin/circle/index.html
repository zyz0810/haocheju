<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>车友圈</title>
    @import "../include/header.inc";

</head>
<body ontouchstart>
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<div class="container" id="container"></div>

<!--首页-->
<link rel="import" href="../../../pages/circle/index.html">

<link rel="import" href="../../../model/templete/circle/list.html"> <!--优惠券列表模板-->
@import "../../../model/widget/include/toast.html";
@import "../../../model/widget/include/dialog.html";
<script src="/weixin/js/wap.min.js"></script>
<script type="text/javascript">
    $(function () {
        pageManager.show("index");
        var userId = cookie.getCookie('userId');
        var myname = cookie.getCookie('userName');

        $('#publish').click(function () {
            window.location.href = '/weixin/circle/send.html';
        });

        var oDiv = document.getElementById('publish');
        var disX, disY, moveX, moveY, L, T, starX, starY, starXEnd, starYEnd;

        // oDiv.addEventListener('touchstart', function (e) {
        //     e.preventDefault();//阻止触摸时页面的滚动，缩放
        //     disX = e.touches[0].clientX - this.offsetLeft;
        //     disY = e.touches[0].clientY - this.offsetTop;
        //     //手指按下时的坐标
        //     starX = e.touches[0].clientX;
        //     starY = e.touches[0].clientY;
        //     //console.log(disX);
        // });
        // oDiv.addEventListener('touchmove', function (e) {
        //     L = e.touches[0].clientX - disX;
        //     T = e.touches[0].clientY - disY;
        //     //移动时 当前位置与起始位置之间的差值
        //     starXEnd = e.touches[0].clientX - starX;
        //     starYEnd = e.touches[0].clientY - starY;
        //     //console.log(L);
        //     if (L < 0) {//限制拖拽的X范围，不能拖出屏幕
        //         L = 0;
        //     }
        //     else if (L > document.documentElement.clientWidth - this.offsetWidth) {
        //         L = document.documentElement.clientWidth - this.offsetWidth;
        //     }
        //
        //     if (T < 0) {//限制拖拽的Y范围，不能拖出屏幕
        //         T = 0;
        //     }
        //     else if (T > document.documentElement.clientHeight - this.offsetHeight) {
        //         T = document.documentElement.clientHeight - this.offsetHeight - 53;
        //     }
        //     moveX = L + 'px';
        //     moveY = T + 'px';
        //     this.style.left = moveX;
        //     this.style.top = moveY;
        // });

        //防止键盘把当前输入框给挡住
        // $('input[type="text"],textarea').on('click', function () {
        //     var target = this;
        //     setTimeout(function(){
        //         target.scrollIntoViewIfNeeded();
        //         console.log('scrollIntoViewIfNeeded');
        //     },400);
        // });


        var timer = null;
        $('input').on('focus', function() {
            clearInterval(timer);
            var index = 0;
            timer = setInterval(function() {
                if(index>5) {
                    $('body').scrollTop(1000000);
                    clearInterval(timer);
                }
                index++;
            }, 50)
        });

        var aa = new contact(function (data) {
            $("#index_slider").silderDot(data, 1800, "");
        });
        aa.list();

        var pge = $(".pageable").pageable({
            loadUpFn: function (me) {
                new contact(function (data) {
                    console.log(data);
                    for(var i = 0; i<data.return_new.length; i++){
                        var str = '';
                        str += '<div class="circle_item weui-cell" data-id="' + data.return_new[i].id + '">';
                        if(data.return_new.headerimg == ''){
                            str += '<div class="weui-cell__hd headImg"><img src="/weixin/images/placeholder/logo.png"/></div>';
                        }else {
                            str += '<div class="weui-cell__hd headImg"><img src="' + data.return_new[i].headerimg + '"/></div>';
                        }
                        str += '<div class="weui-cell__bd cont' + data.return_new[i].id + '">';
                        str += '<span class="f13 gray02">' + data.return_new[i].username + '</span>';
                        str += '<div class="circle_txt f13">' + data.return_new[i].content + '</div>';
                        if(data.return_new[i].images != null){
                            str += '<div class="circle_img clearfix">';
                            for(var j = 0;j < data.return_new[i].images.length; j++){
                                str += '<img class="sendimg" src="' + data.return_new[i].images[j] + '"/>';
                            }
                            str += '</div>';
                        }
                        str += '<div class="weui-cell bordernone operation">';
                        str += '<div class="weui-cell__hd time f10 gray04">' + data.return_new[i].addtime + '</div>';
                        str += '<div class="weui-cell__bd tr" data-id="' + data.return_new[i].id + '">';
                        str += '<i class="iconfont icon-pinglun f20 blue01 operation_btn"></i>';
                        str += '<div class="operationCont gray07_bg f10 weui-flex none" id="' + data.return_new[i].id + '">';
                        str += '<span class="weui-flex__item tc dianzan"><i class="iconfont icon-heart f16"></i>';
                        if(data.return_new[i].isspot == '0'){
                            str += '<span class="dianzan_txt">点赞</span>';
                            str += '<span class="quxiao_txt none">取消</span>';
                        }else{
                            str += '<span class="dianzan_txt none">点赞</span>';
                            str += '<span class="quxiao_txt">取消</span>';
                        }
                        str += '</span>';
                        str += '<span class="weui-flex__item tc pinglun"><i class="iconfont icon-pinglun-copy f16"></i><span>评论</span></span>';
                        str += '</div>';
                        str += '</div>';
                        str += '</div>';

                        if(data.return_new[i].spotlist != '' || data.return_new[i].comment != ''){
                            str += '<div class="operationTxt gray08_bg operationTxt' +  data.return_new[i].id + '">';
                            str += '<span class="arrow_top"></span>';

                            if(data.return_new[i].spotlist != ''){
                                str += '<div class="zan_people">';
                                str += '<i class="iconfont icon-heart f13 blue02"></i>';
                                str += '<div class="blue02 f13">';
                                for(var l = 0; l < data.return_new[i].spotlist.length;l++){
                                    if(l==data.return_new[i].spotlist.length - 1){
                                        str += '<div data-id="' + data.return_new[i].spotlist[l].id + '"><span>' + data.return_new[i].spotlist[l].nickname + '<span></div>';
                                    }else{
                                        str += '<div data-id="' + data.return_new[i].spotlist[l].id + '"><span>' + data.return_new[i].spotlist[l].nickname + '<span>，</div>';
                                    }
                                }
                                str += '</div>';
                                str += '</div>';
                            }

                            if(data.return_new[i].comment != ''){
                                str += '<div class="comment topLine comment' + data.return_new[i].id + '">';
                                for(var k = 0; k<data.return_new[i].comment.length; k++){
                                    if(data.return_new[i].comment[k].pname == ''){
                                        str += '<p class="f13 gray02" data-id="' + data.return_new[i].id + '"><span class="blue02">' + data.return_new[i].comment[k].author + '</span>：'+ data.return_new[i].comment[k].comment + '</p>';
                                    }else{
                                        str += '<p class="f13 gray02" data-id="' + data.return_new[i].id + '"><span class="blue02">' + data.return_new[i].comment[k].pname + '</span> 回复 <span class="blue02">' + data.return_new[i].comment[k].author + '</span>：'+ data.return_new[i].comment[k].comment + '</p>';
                                    }
                                }
                                str += '</div>';
                            }
                            str += '</div>';
                        }
                        str += '</div>';
                        str += '<div class="weui-cell comment_area none comment_area' + data.return_new[i].id + '"><div class="weui-cell__bd"><input type="text" placeholder="评论" class="comment_txt" data-id="' + data.return_new[i].id + '" /></div><div class="weui-cell__ft"><i class="iconfont icon-biaoqing f24 gray04"></i></div></div>';
                        str += '</div>';
                        $(".circle_list").append(str);
                    }
                    $('img').picLazyLoad();
                    pge.resetload();

                }).list({page: 1})
            },
            loadDownFn: function (me) {
                new contact(function (data) {
                    console.log(data);
                    me.pageNumber = me.pageNumber +1;
                    // var circle = render.fill($("#tpl_list"), data.return_new);
                    // $(".circle_list").html(circle);
                    for(var i = 0; i<data.return_new.length; i++){
                        var str = '';
                        str += '<div class="circle_item weui-cell" data-id="' + data.return_new[i].id + '">';
                        if(data.return_new.headerimg == ''){
                            str += '<div class="weui-cell__hd headImg"><img src="/weixin/images/placeholder/logo.png"/></div>';
                        }else {
                            str += '<div class="weui-cell__hd headImg"><img src="' + data.return_new[i].headerimg + '"/></div>';
                        }
                        str += '<div class="weui-cell__bd cont' + data.return_new[i].id + '">';
                        str += '<span class="f13 gray02">' + data.return_new[i].username + '</span>';
                        str += '<div class="circle_txt f13">' + data.return_new[i].content + '</div>';
                        if(data.return_new[i].images != null){
                            str += '<div class="circle_img clearfix">';
                            for(var j = 0;j < data.return_new[i].images.length; j++){
                                str += '<img class="sendimg" src="' + data.return_new[i].images[j] + '"/>';
                            }
                            str += '</div>';
                        }
                        str += '<div class="weui-cell bordernone operation">';
                        str += '<div class="weui-cell__hd time f10 gray04">' + data.return_new[i].addtime + '</div>';
                        str += '<div class="weui-cell__bd tr" data-id="' + data.return_new[i].id + '">';
                        str += '<i class="iconfont icon-pinglun f20 blue01 operation_btn"></i>';
                        str += '<div class="operationCont gray07_bg f10 weui-flex none" id="' + data.return_new[i].id + '">';
                        str += '<span class="weui-flex__item tc dianzan"><i class="iconfont icon-heart f16"></i>';
                        if(data.return_new[i].isspot == '0'){
                            str += '<span class="dianzan_txt">点赞</span>';
                            str += '<span class="quxiao_txt none">取消</span>';
                        }else{
                            str += '<span class="dianzan_txt none">点赞</span>';
                            str += '<span class="quxiao_txt">取消</span>';
                        }
                        str += '</span>';
                        str += '<span class="weui-flex__item tc pinglun"><i class="iconfont icon-pinglun-copy f16"></i><span>评论</span></span>';
                        str += '</div>';
                        str += '</div>';
                        str += '</div>';

                        if(data.return_new[i].spotlist != '' || data.return_new[i].comment != ''){
                            str += '<div class="operationTxt gray08_bg operationTxt' +  data.return_new[i].id + '">';
                            str += '<span class="arrow_top"></span>';

                            if(data.return_new[i].spotlist != ''){
                                str += '<div class="zan_people">';
                                str += '<i class="iconfont icon-heart f13 blue02"></i>';
                                str += '<div class="blue02 f13">';
                                for(var l = 0; l < data.return_new[i].spotlist.length;l++){
                                    if(l==data.return_new[i].spotlist.length - 1){
                                        str += '<div data-id="' + data.return_new[i].spotlist[l].id + '"><span>' + data.return_new[i].spotlist[l].nickname + '<span></div>';
                                    }else{
                                        str += '<div data-id="' + data.return_new[i].spotlist[l].id + '"><span>' + data.return_new[i].spotlist[l].nickname + '<span>，</div>';
                                    }
                                }
                                str += '</div>';
                                str += '</div>';
                            }

                            if(data.return_new[i].comment != ''){
                                if(data.return_new[i].comment.length > 6){
                                    str += '<div class="comment more_height topLine comment' + data.return_new[i].id + '">';
                                }else{
                                    str += '<div class="comment topLine comment' + data.return_new[i].id + '">';
                                }
                                for(var k = 0; k<data.return_new[i].comment.length; k++){
                                    if(data.return_new[i].comment[k].pname == ''){
                                        str += '<p class="f13 gray02" data-id="' + data.return_new[i].id + '"><span class="blue02">' + data.return_new[i].comment[k].author + '</span>：'+ data.return_new[i].comment[k].comment + '</p>';
                                    }else{
                                        str += '<p class="f13 gray02" data-id="' + data.return_new[i].id + '"><span class="blue02">' + data.return_new[i].comment[k].pname + '</span> 回复 <span class="blue02">' + data.return_new[i].comment[k].author + '</span>：'+ data.return_new[i].comment[k].comment + '</p>';
                                    }
                                }
                                if(data.return_new[i].comment.length > 6){
                                    str += '<div class="more_comment f12 tc gray02 gray08_bg blue02">更多</div>';
                                }
                                str += '</div>';
                            }
                            str += '</div>';
                        }
                        str += '</div>';
                        str += '<div class="weui-cell comment_area none comment_area' + data.return_new[i].id + '"><div class="weui-cell__bd"><input type="text" placeholder="评论" class="comment_txt" data-id="' + data.return_new[i].id + '" /></div><div class="weui-cell__ft"><i class="iconfont icon-biaoqing f24 gray04"></i></div></div>';
                        str += '</div>';
                        $(".circle_list").append(str);
                    }

                    $('img').picLazyLoad();
                    if (data.return_new.length < 10) {
                        pge.lock();
                        pge.noData();
                    }
                    pge.resetload();

                }).list({page: me.pageNumber,userId:userId});
            }
        });



        $(document).on('click','.operation_btn',function () {
            var id = $(this).parent().attr('data-id');
            console.log(id);
            $('#' + id).toggleClass('none');
        });

        // $(document).on('click','.pinglun',function () {
        $('.pinglun').die().live('click',function () {
            var id = $(this).parent().attr('data-id');
            $('#' + id).addClass('none');
            var $this=$(this);
            var myname = $(this).attr('data-name');
            var id = $(this).parent().attr('id');
            $(".comment_area" + id).removeClass('none');
            $('.foot_menu').addClass('none');
            $(".comment_area" + id).find('input').focus();

            $(".comment_area" + id).find('input').die().live('change',function () {
                var $sth=$(this);
                var content= $(".comment_area" + id).find('input').val();
                new contact(function (data) {
                    $(".comment_area" + id).addClass('none');
                    $('.foot_menu').removeClass('none');
                    $this.parent().parent().parent().parent().find('.comment').append('<p class="f13 gray02"><span class="blue02">' + myname + '：</span>'+ content + '</p>');
                    $(this).val('');
                }).reply({pauthor:'',author:myname,cid:id,comment:content});
                $(".comment_area" + id).find('input').val('');
            })
        });


        //回复下方已有的评论
        // $('.comment p').click(function() {
        $(document).on('click','.comment p',function () {
            var id = $(this).attr('data-id');
            $('#' + id).addClass('none');
            var $this=$(this);
            var rewho=$this.find('.blue02').first().html();
            var id=$(this).attr('data-id');
            $(".comment_area" + id).removeClass('none');
            $('.foot_menu').addClass('none');
            $(".comment_area" + id).find('input').focus();
            $(".comment_area" + id).find('input').attr('placeholder','回复'+rewho);
            $(".comment_area" + id).find('input').die().live('change',function () {
                var content=$(".comment_area" + id).find('input').val();
                var $sth=$(this);
                new contact(function (data) {
                    $(".comment_area" + id).addClass('none');
                    $('.foot_menu').removeClass('none');
                    $this.after('<p class="f13 gray02"><span class="blue02">' + myname + '</span> 回复 <span class="blue02">' + rewho + '：</span>'+ content + '</p>');
                }).reply({pauthor:rewho,author:myname,cid:id,comment:content});
                $(".comment_area" + id).find('input').val('');
            })
        });


        //预览大图
        var imgsObj = $('.sendimg');
        var imgs = new Array();
        for(var i = 0; i < imgsObj.size(); i++){
            imgs.push(imgsObj.eq(i).attr('src'));
        }
        $(document).on('click','.sendimg',function () {
            WeixinJSBridge.invoke('imagePreview', {
                'current': $(this).attr('src'),
                'urls': imgs
            });
        });

        var timer = null;
        $('input').on('focus', function() {
            clearInterval(timer);
            var index = 0;
            timer = setInterval(function() {
                if(index>5) {
                    $('body').scrollTop(1000000);
                    clearInterval(timer);
                }
                index++;
            }, 50)
        });
        //点赞
        $(document).on('click','.dianzan',function () {
            var $this = $(this);
            var id = $(this).parent().attr('id');
            console.log(id);
            new contact(function (data) {
                $('#' + id).addClass('none');
                console.log('点赞：'+data.isspot);
                console.log(data);

                if(data.isspot == '0'){
                    console.log('取消点赞');
                    $('#' + id).find('.dianzan_txt').removeClass('none');
                    $('#' + id).find('.quxiao_txt').addClass('none');
                    if(data.spotlist.length>0){
                        if($('.cont' + id + '>div').hasClass('operationTxt')){
                            var zanList = '';
                            zanList += '<div class="zan_people">';
                            zanList += '<i class="iconfont icon-heart f13 blue02"></i>';
                            zanList += '<div class="blue02 f13">';
                            for(var m = 0; m < data.spotlist.length;m++){
                                if(m == data.spotlist.length - 1){
                                    zanList += '<div data-id="' + data.spotlist[m].id + '"><span>' + data.spotlist[m].nickname + '<span></div>';
                                }else{
                                    zanList += '<div data-id="' + data.spotlist[m].id + '"><span>' + data.spotlist[m].nickname + '<span>，</div>';
                                }

                            }
                            zanList += '</div>';
                            zanList += '</div>';
                            $('.cont' + id).find('.operationTxt').prepend(zanList);

                        }else{
                            var zanList = '';
                            zanList += '<div class="operationTxt gray08_bg"><span class="arrow_top"></span>';
                            zanList += '<div class="zan_people">';
                            zanList += '<i class="iconfont icon-heart f13 blue02"></i>';
                            zanList += '<div class="blue02 f13">';
                            for(var m = 0; m < data.spotlist.length;m++){
                                if(m==data.spotlist.length - 1){
                                    zanList += '<div data-id="' + data.spotlist[m].id + '"><span>' + data.spotlist[m].nickname + '<span></div>';
                                }else{
                                    zanList += '<div data-id="' + data.spotlist[m].id + '"><span>' + data.spotlist[m].nickname + '<span>，</div>';
                                }

                            }
                            zanList += '</div>';
                            zanList += '</div>';
                            zanList += '</div>';
                            $('.cont'+id).append(zanList);
                        }
                    }else{
                        if($('.cont' + id).find('.operationTxt').children().hasClass('comment')){
                            $('.comment'+id).parent().find('.zan_people').remove();
                        }else{
                            $('.cont' + id).find('.operationTxt').remove();
                        }
                    }
                }else{
                    $('#' + id).find('.dianzan_txt').addClass('none');
                    $('#' + id).find('.quxiao_txt').removeClass('none');
                    if(data.spotlist.length>0){
                        if($('.cont' + id + '>div').hasClass('operationTxt')){
                            var zanList = '';
                            zanList += '<div class="zan_people">';
                            zanList += '<i class="iconfont icon-heart f13 blue02"></i>';
                            zanList += '<div class="blue02 f13">';
                            for(var m = 0; m < data.spotlist.length;m++){
                                if(m == data.spotlist.length - 1){
                                    zanList += '<div data-id="' + data.spotlist[m].id + '"><span>' + data.spotlist[m].nickname + '<span></div>';
                                }else{
                                    zanList += '<div data-id="' + data.spotlist[m].id + '"><span>' + data.spotlist[m].nickname + '<span>，</div>';
                                }
                            }
                            zanList += '</div>';
                            zanList += '</div>';
                            $('.cont' + id).find('.operationTxt').prepend(zanList);
                        }else{
                            var zanList = '';
                            zanList += '<div class="operationTxt gray08_bg"><span class="arrow_top"></span>';
                            zanList += '<div class="zan_people">';
                            zanList += '<i class="iconfont icon-heart f13 blue02"></i>';
                            zanList += '<div class="blue02 f13">';
                            for(var m = 0; m < data.spotlist.length;m++){
                                if(m==data.spotlist.length - 1){
                                    zanList += '<div data-id="' + data.spotlist[m].id + '"><span>' + data.spotlist[m].nickname + '<span></div>';
                                }else{
                                    zanList += '<div data-id="' + data.spotlist[m].id + '"><span>' + data.spotlist[m].nickname + '<span>，</div>';
                                }
                            }
                            zanList += '</div>';
                            zanList += '</div>';
                            zanList += '</div>';
                            $('.cont'+id).append(zanList);
                        }
                    }else{
                        if($('.cont' + id).find('.operationTxt').children().hasClass('comment')){
                            $('.comment'+id).parent().find('.zan_people').remove();
                        }else{
                            $('.cont' + id).find('.operationTxt').remove();
                        }
                    }
                }
            }).liked({pid:id,userId:1})
        });

        //更多评论
        $(document).on('click','.more_comment',function () {

            if($(this).parent().hasClass('more_height')){
                $(this).parent().removeClass('more_height');
                $(this).html('收起')
            }else{
                $(this).parent().addClass('more_height');
                $(this).html('查看更多')
            }
        })


    });
</script>

</body>
</html>